package gameServer;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.HashMap;
import java.util.TreeMap;

public class GameMachine {
	private static GameMachine theMachine;
	
	HashMap <String, Integer> playerNameLevel; // <playerName, playerLevel>
	HashMap <String, Integer> playerNameScore; // <playername, score>
	TreeMap <Integer, String> highScore; // act as database for high score, user TreeMap for sorting
	String ack = "false";
	
	public HashMap<String, Integer> getPlayerNameLevel() {
		return playerNameLevel;
	}

	public void setPlayerNameLevel(HashMap<String, Integer> playerNameLevel) {
		this.playerNameLevel = playerNameLevel;
	}

	public HashMap<String, Integer> getPlayerNameScore() {
		return playerNameScore;
	}

	public void setPlayerNameScore(HashMap<String, Integer> playerNameScore) {
		this.playerNameScore = playerNameScore;
	}
	
	public TreeMap <Integer, String> getHigScore () {
		return highScore;
	}

	public void setHighScore(TreeMap<Integer, String> highScore) {
		this.highScore = highScore;
	}
	
	public String getAck() {
		return ack;
	}

	public void setAck(String ack) {
		this.ack = ack;
	}

	public static GameMachine getInstance() {
		if (theMachine == null) {
			theMachine = new GameMachine() ;
			theMachine.init( ) ;
			return theMachine ;
		}
		else {
			return theMachine ;
		}
	}

	private void init( ) {
		playerNameLevel = new HashMap<> ();
		playerNameScore = new HashMap<> ();
		highScore = new TreeMap<> ();
		
		FileReader in = null;

		try {
			File yourFile = new File("highScore.txt");
			yourFile.createNewFile();
			in = new FileReader(yourFile);
			BufferedReader br = new BufferedReader(in);
			String line = null;
			while ((line = br.readLine()) != null){
				String[] tokens = line.split("|");
				
				String playerName = tokens[0];
				int score = Integer.parseInt(tokens[1]);
				int level = Integer.parseInt(tokens[2]);
				
				this.playerNameLevel.put(playerName, level);
				this.playerNameScore.put(playerName, score);
				this.highScore.put(score, playerName);
			}
			in.close();
		} catch (FileNotFoundException e) {
			System.out.println("init: FileNotFoundException");
		} catch (IOException e) {
			System.out.println("init: IOException");
		} 
	}

	public void registerPlayer(String playerName) {
		if (this.playerNameLevel.get(playerName) != null ) {
			this.ack = "false";
		} else {
			this.playerNameLevel.put(playerName, 0);
			this.playerNameScore.put(playerName, 0);
			this.ack = "true";
		}
		
	}

	public void setLevel(String playerName, int level) {
		if (this.playerNameLevel.get(playerName) == null ) {
			this.ack = "false";
		} else {
			this.playerNameLevel.put(playerName, level);
			this.ack = "true";
		}
		
	}

	public void setScore(String playerName, int score) {
		if (this.playerNameScore.get(playerName) == null ) {
			this.ack = "false";
		} else {
			this.playerNameScore.put(playerName, score);
			try {
				FileWriter fw = new FileWriter("highScore", true);
				BufferedWriter bw = new BufferedWriter(fw);
				PrintWriter out = new PrintWriter(bw);

				out.println(playerName + "|" + score + this.playerNameLevel.get(playerName));
				
				out.close();

			} catch (IOException e) {
				System.out.println("setScore: IOExecption");
				this.ack = "false";
				return;
			}
			this.ack = "true";
		}
	}

	public int calculateScore(int correctScore, int time) {
		return 0;
	}

}
